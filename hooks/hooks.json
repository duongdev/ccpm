{
  "$schema": "https://code.claude.com/schemas/settings.json",
  "description": "CCPM Plugin Hooks - Smart agent auto-invocation for optimal workflow",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup|resume|clear|compact",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/session-init.cjs",
            "timeout": 5000,
            "description": "Initializes CCPM session: detects project, git state, CLAUDE.md files, persists state"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/smart-agent-selector.sh",
            "timeout": 5000,
            "description": "Smart agent selector: Dynamically discovers and scores all available agents"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Read|WebFetch|Task",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/scout-block.cjs",
            "timeout": 1000,
            "description": "Scout block: Pre-filters tool calls to avoid wasted tokens (30-50% savings)"
          }
        ]
      },
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/delegation-enforcer.cjs",
            "timeout": 500,
            "description": "Delegation enforcer: Warns when Edit/Write used during /ccpm:work AI mode"
          }
        ]
      },
      {
        "matcher": "Write|Edit|Task|Bash",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/context-capture.cjs",
            "timeout": 500,
            "description": "Context capture: Auto-logs file changes, task completions, and decisions for subagent context"
          }
        ]
      },
      {
        "matcher": "mcp__agent-mcp-gateway__execute_tool",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/linear-param-fixer.sh",
            "timeout": 2000,
            "description": "Linear parameter fixer: Catches issueId vs id mistakes before they fail"
          }
        ]
      }
    ],
    "SubagentStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/subagent-context-injector.cjs",
            "timeout": 3000,
            "description": "Injects comprehensive CCPM context (CLAUDE.md, project, task, rules) to all subagents (~10k tokens)"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/work-loop-stop-hook.sh",
            "timeout": 3000,
            "description": "Work loop: Intercepts exit to continue iterative implementation (ralph-wiggum pattern)"
          },
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/guard-commit.cjs",
            "timeout": 5000,
            "description": "Guard commit: Warns about uncommitted changes when session ends to prevent work loss"
          }
        ]
      }
    ]
  },
  "usage": {
    "installation": "This file is automatically applied when the CCPM plugin is installed",
    "customization": "Users can disable specific hooks in their project's .claude/settings.json",
    "optimization": "Using optimized hook prompts: 81.7% token reduction, <1s execution with caching"
  },
  "notes": {
    "session_init": {
      "purpose": "Initializes CCPM session and gathers comprehensive project context",
      "trigger": "SessionStart (startup, resume, clear, compact)",
      "execution": "At the start of each session",
      "output": "Full CCPM context: agents, rules, commands (~1.2K tokens once)",
      "problem_solved": "Avoids context flooding from per-message injection (94% reduction)",
      "features": [
        "Detects Linear issue from git branch (e.g., WORK-26)",
        "Detects project name from git remote or directory",
        "Captures git state: uncommitted files, last commit",
        "Discovers all CLAUDE.md files in project hierarchy",
        "Extracts key rules from CLAUDE.md files",
        "Discovers all available agents (plugin + project)",
        "Injects agent invocation rules table",
        "Injects CCPM slash command reference",
        "Persists state to /tmp/ccpm-session-{sessionId}.json",
        "Initializes context log file for session activity",
        "Exports env vars: CCPM_SESSION_ID, CCPM_ACTIVE_ISSUE, CCPM_ACTIVE_PROJECT, CCPM_CONTEXT_LOG",
        "Fail-open design (doesn't block session start on errors)"
      ]
    },
    "smart_agent_selector": {
      "purpose": "Provides lightweight task-specific agent hints per message",
      "trigger": "UserPromptSubmit",
      "execution": "Before Claude starts responding",
      "output": "Minimal hint (~15 tokens) when keywords detected, nothing otherwise",
      "performance": "94% token reduction vs v1.0 (full context now in SessionStart)",
      "features": [
        "Keyword-based task detection",
        "Minimal context injection (~15 tokens max)",
        "No agent discovery (moved to SessionStart)",
        "Fast execution (<100ms)"
      ]
    },
    "scout_block": {
      "purpose": "Pre-filters tool calls to avoid wasted tokens on operations that will fail",
      "trigger": "PreToolUse (Read, WebFetch, Task)",
      "execution": "Before Read, WebFetch, or Task tool execution",
      "output": "Blocks tool with reason and suggestion, or allows through",
      "problem_solved": "Wasted tokens on: non-existent files, invalid URLs, malformed Task calls",
      "savings": "30-50% token reduction by preventing failed tool calls",
      "features": [
        "Read: Checks file exists, size < 5MB, not binary",
        "WebFetch: Validates URL format, blocks localhost/internal",
        "Task: Ensures subagent_type and prompt are provided",
        "Fast execution (< 100ms) - file system checks only",
        "Provides helpful suggestions on block"
      ]
    },
    "context_capture": {
      "purpose": "Auto-captures session context from tool calls for subagent injection",
      "trigger": "PreToolUse (Write, Edit, Task, Bash)",
      "execution": "Before Write, Edit, Task, or Bash tool execution",
      "output": "Appends entries to /tmp/ccpm-context-{issueId}.log",
      "problem_solved": "Subagents don't know what happened earlier in the session",
      "cost": "Zero tokens to main agent (purely observational)",
      "features": [
        "Captures file creations (Write tool)",
        "Captures file modifications (Edit tool)",
        "Captures task starts with agent type",
        "Captures test runs and builds (Bash)",
        "Captures git commits",
        "Extracts decisions from task prompts",
        "Timestamp-prefixed entries for chronology",
        "Fail-open design (never blocks tool calls)"
      ]
    },
    "delegation_enforcer": {
      "purpose": "Light reminder about agent delegation for implementation files",
      "trigger": "PreToolUse (Edit, Write)",
      "execution": "Before Edit or Write tool execution on implementation files",
      "output": "Brief tip suggesting Task delegation for multi-file changes",
      "problem_solved": "Gentle nudge towards agent delegation without blocking",
      "features": [
        "Only triggers on implementation files (*.ts, *.tsx, src/, etc.)",
        "Skips config/doc files (*.md, *.json, package.json, etc.)",
        "Suggests appropriate agent based on file type",
        "Advisory only - never blocks",
        "Brief one-line tip, not intrusive"
      ],
      "design": "Main enforcement is via explicit option labels in /ccpm:work ('Delegate to agents' vs 'Quick inline edit')"
    },
    "linear_param_fixer": {
      "purpose": "Catches and warns about common Linear MCP parameter mistakes",
      "trigger": "PreToolUse (mcp__agent-mcp-gateway__execute_tool)",
      "execution": "Before MCP tool execution",
      "output": "Warning message if wrong parameters detected (issueId vs id)",
      "problem_solved": "get_issue/update_issue use 'id', but create_comment uses 'issueId'",
      "features": [
        "Detects issueId used where id expected",
        "Detects id used where issueId expected",
        "Shows correct parameter format",
        "Prevents token waste from failed calls"
      ]
    },
    "subagent_context_injector": {
      "purpose": "Injects comprehensive CCPM context into all subagents",
      "trigger": "SubagentStart",
      "execution": "When any subagent is spawned via Task tool",
      "output": "Injects up to ~10k tokens of rich context",
      "problem_solved": "Subagents don't follow project instructions or lose context",
      "features": [
        "Injects full CLAUDE.md contents (up to 15k chars)",
        "Project hierarchy: root + monorepo subdirectories",
        "Agent-specific rules: tailored guidance per agent type",
        "Task context: issue, branch, uncommitted files",
        "Session context: recent activity from context log",
        "Git state: uncommitted files, last commit",
        "Global CCPM rules: Linear ops, git safety, etc.",
        "Prioritized sections: CLAUDE.md first (most important)",
        "Fail-open design (exits 0 with minimal context on errors)"
      ],
      "context_sections": [
        "1. CLAUDE.md files (~5k tokens) - Full project instructions",
        "2. Task context (~500 tokens) - Issue, branch, progress",
        "3. Agent-specific rules (~500 tokens) - Detailed agent guidance",
        "4. Session context (~500 tokens) - Recent decisions, completions",
        "5. Git state (~200 tokens) - Uncommitted files, recent commits",
        "6. Global rules (~200 tokens) - CCPM-wide rules"
      ],
      "agent_rules": [
        "ccpm:frontend-developer - Component patterns, styling, accessibility, state",
        "ccpm:backend-architect - API patterns, database, auth, error handling",
        "ccpm:debugger - Investigation, root cause, fixing, prevention",
        "ccpm:code-reviewer - Security, code quality, testing, maintainability",
        "ccpm:security-auditor - Injection, auth, authorization, data protection",
        "ccpm:tdd-orchestrator - Red-green-refactor, test quality",
        "ccpm:linear-operations - Parameter names, caching, batching, errors",
        "Explore - Search strategy, efficiency, reporting",
        "Plan - Analysis, task breakdown, dependencies"
      ]
    },
    "work_loop_stop_hook": {
      "purpose": "Enables autonomous iterative work by intercepting session exit (ralph-wiggum pattern)",
      "trigger": "Stop",
      "execution": "When Claude attempts to exit/complete during active work loop",
      "output": "Block decision with continuation prompt, or allow exit on completion/blocker",
      "problem_solved": "Manual intervention needed between checklist items during autonomous work",
      "features": [
        "Detects active work loop via state file (.claude/ccpm-work-loop.local.md)",
        "Checks for completion promise (<promise>ALL_ITEMS_COMPLETE</promise>)",
        "Checks for blocker signal (Status: Blocked) to pause loop",
        "Increments iteration counter and re-feeds continuation prompt",
        "Max iterations safety limit (default: 30)",
        "Clean state file removal on completion/max iterations",
        "Portable sed syntax for macOS/Linux compatibility"
      ],
      "state_file_format": {
        "location": ".claude/ccpm-work-loop.local.md",
        "fields": [
          "issue_id - Linear issue being worked on",
          "iteration - Current iteration count",
          "max_iterations - Safety limit",
          "completion_promise - Signal for successful completion",
          "branch - Git branch name",
          "started_at - Loop start timestamp",
          "last_sync_at - Last iteration timestamp"
        ]
      },
      "inspired_by": "ralph-wiggum plugin (anthropics/claude-code)"
    },
    "guard_commit": {
      "purpose": "Prevents work loss by warning about uncommitted changes when session ends",
      "trigger": "Stop",
      "execution": "When Claude stops responding (session end, throttle, context full)",
      "output": "Warning with file count, line count, and suggested commit command",
      "problem_solved": "Work loss when session ends unexpectedly with uncommitted changes",
      "features": [
        "Detects uncommitted files (staged and unstaged)",
        "Counts changed lines for threshold comparison",
        "Configurable thresholds: CCPM_GUARD_COMMIT_MAX_FILES (default: 5)",
        "Configurable thresholds: CCPM_GUARD_COMMIT_MAX_LINES (default: 100)",
        "Suggests commit message based on file types",
        "Extracts issue ID from branch name for commit scope",
        "Updates session state with guard trigger info",
        "Non-blocking: always exits 0"
      ],
      "configuration": {
        "CCPM_GUARD_COMMIT_MAX_FILES": "Trigger if more than N files changed (default: 5)",
        "CCPM_GUARD_COMMIT_MAX_LINES": "Trigger if more than N lines changed (default: 100)",
        "CCPM_GUARD_COMMIT_AUTO": "If 'true', suggest auto-commit command (default: false)"
      },
      "inspired_by": "CCharness guard-commit pattern (https://github.com/elct9620/ccharness)"
    }
  },
  "statusline": {
    "location": "hooks/settings.json",
    "purpose": "Displays project, issue, progress, branch in CLI status bar",
    "features": [
      "Shows active CCPM project (cyan)",
      "Shows current Linear issue ID (green)",
      "Shows checklist progress % with color coding (red/yellow/green)",
      "Shows git branch (magenta, shortened)",
      "Reads session state from /tmp/ccpm-session-*.json",
      "Falls back to CCPM_* env vars if session not available"
    ],
    "format": "project │ ISSUE-ID │ progress% │ branch",
    "example": "ccpm │ WORK-26 │ 75% │ add-improvements"
  },
  "removed_hooks": {
    "tdd_enforcer": {
      "reason": "Removed in v1.0 for simplicity - developers manage their own testing workflow",
      "alternative": "Use /ccpm:verify for quality checks before finalizing tasks"
    },
    "quality_gate": {
      "reason": "Removed in v1.0 - integrated into /ccpm:verify command instead",
      "alternative": "Run /ccpm:verify to perform quality checks and code review"
    }
  }
}
