{
  "$schema": "https://code.claude.com/schemas/settings.json",
  "description": "CCPM Plugin Hooks - Smart agent auto-invocation for optimal workflow",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup|resume|clear|compact",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/session-init.cjs",
            "timeout": 3000,
            "description": "Initializes CCPM session: detects project, issue from branch, persists state"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/smart-agent-selector.sh",
            "timeout": 5000,
            "description": "Smart agent selector: Dynamically discovers and scores all available agents"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Read|WebFetch|Task",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/scout-block.cjs",
            "timeout": 1000,
            "description": "Scout block: Pre-filters tool calls to avoid wasted tokens (30-50% savings)"
          }
        ]
      },
      {
        "matcher": "mcp__agent-mcp-gateway__execute_tool",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/linear-param-fixer.sh",
            "timeout": 2000,
            "description": "Linear parameter fixer: Catches issueId vs id mistakes before they fail"
          }
        ]
      }
    ],
    "SubagentStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/hooks/scripts/subagent-context-injector.cjs",
            "timeout": 2000,
            "description": "Injects CCPM context (issue, project, rules) to all subagents"
          }
        ]
      }
    ]
  },
  "usage": {
    "installation": "This file is automatically applied when the CCPM plugin is installed",
    "customization": "Users can disable specific hooks in their project's .claude/settings.json",
    "optimization": "Using optimized hook prompts: 81.7% token reduction, <1s execution with caching"
  },
  "notes": {
    "session_init": {
      "purpose": "Initializes CCPM session and injects full context once per session",
      "trigger": "SessionStart (startup, resume, clear, compact)",
      "execution": "At the start of each session",
      "output": "Full CCPM context: agents, rules, commands (~1.2K tokens once)",
      "problem_solved": "Avoids context flooding from per-message injection (94% reduction)",
      "features": [
        "Detects Linear issue from git branch (e.g., WORK-26)",
        "Detects project name from git remote or directory",
        "Discovers all available agents (plugin + project)",
        "Injects agent invocation rules table",
        "Injects CCPM slash command reference",
        "Persists state to /tmp/ccpm-session-{sessionId}.json",
        "Exports env vars: CCPM_SESSION_ID, CCPM_ACTIVE_ISSUE, CCPM_ACTIVE_PROJECT",
        "Fail-open design (doesn't block session start on errors)"
      ]
    },
    "smart_agent_selector": {
      "purpose": "Provides lightweight task-specific agent hints per message",
      "trigger": "UserPromptSubmit",
      "execution": "Before Claude starts responding",
      "output": "Minimal hint (~15 tokens) when keywords detected, nothing otherwise",
      "performance": "94% token reduction vs v1.0 (full context now in SessionStart)",
      "features": [
        "Keyword-based task detection",
        "Minimal context injection (~15 tokens max)",
        "No agent discovery (moved to SessionStart)",
        "Fast execution (<100ms)"
      ]
    },
    "scout_block": {
      "purpose": "Pre-filters tool calls to avoid wasted tokens on operations that will fail",
      "trigger": "PreToolUse (Read, WebFetch, Task)",
      "execution": "Before Read, WebFetch, or Task tool execution",
      "output": "Blocks tool with reason and suggestion, or allows through",
      "problem_solved": "Wasted tokens on: non-existent files, invalid URLs, malformed Task calls",
      "savings": "30-50% token reduction by preventing failed tool calls",
      "features": [
        "Read: Checks file exists, size < 5MB, not binary",
        "WebFetch: Validates URL format, blocks localhost/internal",
        "Task: Ensures subagent_type and prompt are provided",
        "Fast execution (< 100ms) - file system checks only",
        "Provides helpful suggestions on block"
      ]
    },
    "linear_param_fixer": {
      "purpose": "Catches and warns about common Linear MCP parameter mistakes",
      "trigger": "PreToolUse (mcp__agent-mcp-gateway__execute_tool)",
      "execution": "Before MCP tool execution",
      "output": "Warning message if wrong parameters detected (issueId vs id)",
      "problem_solved": "get_issue/update_issue use 'id', but create_comment uses 'issueId'",
      "features": [
        "Detects issueId used where id expected",
        "Detects id used where issueId expected",
        "Shows correct parameter format",
        "Prevents token waste from failed calls"
      ]
    },
    "subagent_context_injector": {
      "purpose": "Injects CCPM context into all subagents automatically",
      "trigger": "SubagentStart",
      "execution": "When any subagent is spawned via Task tool",
      "output": "Injects ~200 tokens of context (issue, project, rules)",
      "problem_solved": "Subagents lose context about active Linear issue, project config, and CCPM rules",
      "features": [
        "Reads session state from /tmp/ccpm-session-*.json",
        "Reads CCPM_ACTIVE_ISSUE and CCPM_ACTIVE_PROJECT env vars",
        "Injects Linear issue ID and title (if available)",
        "Injects active project name",
        "Injects key CCPM rules (Linear ops via agent, no auto-commit)",
        "Fail-open design (exits 0 with minimal context on errors)"
      ]
    }
  },
  "statusline": {
    "location": "hooks/settings.json",
    "purpose": "Displays project, issue, progress, branch in CLI status bar",
    "features": [
      "Shows active CCPM project (cyan)",
      "Shows current Linear issue ID (green)",
      "Shows checklist progress % with color coding (red/yellow/green)",
      "Shows git branch (magenta, shortened)",
      "Reads session state from /tmp/ccpm-session-*.json",
      "Falls back to CCPM_* env vars if session not available"
    ],
    "format": "project │ ISSUE-ID │ progress% │ branch",
    "example": "ccpm │ WORK-26 │ 75% │ add-improvements"
  },
  "removed_hooks": {
    "tdd_enforcer": {
      "reason": "Removed in v1.0 for simplicity - developers manage their own testing workflow",
      "alternative": "Use /ccpm:verify for quality checks before finalizing tasks"
    },
    "quality_gate": {
      "reason": "Removed in v1.0 - integrated into /ccpm:verify command instead",
      "alternative": "Run /ccpm:verify to perform quality checks and code review"
    }
  }
}
